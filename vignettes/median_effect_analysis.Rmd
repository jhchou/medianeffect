---
title: "Using the medianeffect package for dose-effect analysis"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{median_effect_analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
csl: cell.csl
bibliography: medianeffect.bib
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  fig.align = 'center', # left, right, center, default
  fig.width = 6, # dimensions of plots in inches
  fig.height = 4,
  fig.retina = 3,
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, include = FALSE, eval = FALSE}
# suppressMessages(suppressWarnings(library(tidyverse)))
```

In this document, I replicate analysis from [@chouComputerizedQuantitationSynergism1994] using the R `medianeffect` package. Background information on the Median Effect Principle and analysis of combinations of drugs are provided in the Appendix below.

* Chou, T. C., R. J. Motzer, Y. Tong, and G. J. Bosl. 1994. "Computerized Quantitation of Synergism and Antagonism of Taxol, Topotecan, and Cisplatin against Human Teratocarcinoma Cell Growth: A Rational Approach to Clinical Protocol Design." Journal of the National Cancer Institute 86 (20): 1517–24. https://doi.org/10.1093/jnci/86.20.1517.

The drug dose-effect data is taken from Table 3, detailing the effect of paclitaxel, cisplatin, and topotecan individually and in 2- and 3-drug combinations on inhibition of 833K teratocarcinoma cells.

## Setup

If not already done, the first step is to install the `medianeffect` package from GitHub. Package installation only has to be done once.

The [package is available on GitHub](https://github.com/jhchou/medianeffect) under the permissive [MIT open source license](https://opensource.org/licenses/MIT), allowing rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, subject to the condition that the copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.

```{r, eval = FALSE}
devtools::install_github("jhchou/medianeffect", build_vignettes = TRUE)
```

Once installed, load the `medianeffect` package. This document is available via `vignette('median_effect_analysis')`

```{r}
library(medianeffect)
```

## Single drug effects

Drug effect objects are then created with the `drug_effects` function. As each one is created, the dose-effect parameters (e.g., m and Dm) are calculated and stored with the object.

Displaying the object (with `print(object)` or just `object` interactively) shows the doses, effects, calculated m and Dm parameters, and the coefficient of determination (R^2) from the linear regression fit. Historically, R was also reported in median effect analysis, so it is included as well.

### Single drug: paclitaxel

```{r}
drug1 <- drug_effects(
  D = c(0.002, 0.004, 0.005, 0.01, 0.02),
  fa = c(0.429, 0.708, 0.761, 0.882, 0.932),
  name = "Paclitaxel",
  label = "Paclitaxel")
drug1
```

### Single drug: cisplatin

```{r}
drug2 <- drug_effects(
  D = c(0.05, 0.1, 0.2, 0.5, 1, 2),
  fa = c(0.055, 0.233, 0.301, 0.559, 0.821, 0.953),
  name = "Cisplatin",
  label = "cis-pt")
drug2
```

### Single drug: topotecan

```{r}
drug3 <- drug_effects(
  D = c(0.01, 0.02, 0.05, 0.1, 0.2, 0.5),
  fa = c(0.069, 0.213, 0.373, 0.785, 0.94, 0.991),
  name = 'Topotecan',
  label = 'Topotecan'
)
drug3
```

## Multi-drug combination effects

Next, the 2- and 3-drug constant ratio combination drug effect objects are created, also using the `drug_effects` function, but now specifying the ratio of doses between the different drugs. The doses entered are the **sum** of all the doses, and the ratio is used to calculate the individual drug dose contributions.

If the sum of the doses is not known, `R` vector addition can be used to generate the sums, as done here.

### Two-drug constant ratio combination: paclitaxel and cisplatin

```{r}
combo_1_2 <- drug_effects(
  D = c(0.001, 0.002, 0.005, 0.01) + c(0.1, 0.2, 0.5, 1),
  fa = c(0.45, 0.701, 0.910, 0.968),
  name = 'Paclitaxel - Cisplatin',
  label = 'taxol:cispt',
  ratio = c(0.001, 0.1))
combo_1_2
```

### Two-drug constant ratio combination: cisplatin and topotecan

```{r}
combo_2_3 <- drug_effects(
  D = c(0.05, 0.1, 0.2, 0.5, 1) + c(0.005, 0.01, 0.02, 0.05, 0.1),
  fa = c(0.304, 0.413, 0.675, 0.924, 0.977),
  name = 'Cisplatin - Topotecan',
  label = 'combo_2_3',
  ratio = c(0.1, 0.01))
combo_2_3
```

### Two-drug constant ratio combination: paclitaxel and topotecan

```{r}
combo_1_3 <- drug_effects(
  D = c(0.001, 0.002, 0.005, 0.01) + c(0.01, 0.02, 0.05, 0.1),
  fa = c(0.274, 0.579, 0.901, 0.965),
  name = 'Paclitaxel - Topotecan',
  label = 'combo_1_3',
  ratio = c(0.01, 0.1))
combo_1_3
```

### Three-drug constant ratio combination: paclitaxel, cisplatin, and topotecan

A three-drug combination object is generated by changing the `ratio` term to include 3 elements.

```{r}
combo_1_2_3 <- drug_effects(
  D = c(0.001, 0.002, 0.003, 0.005) + c(0.1, 0.2, 0.3, 0.5) + c(0.01, 0.02, 0.03, 0.05),
  fa = c(0.456, 0.806, 0.947, 0.995),
  name = 'Paclitaxel - Cisplatin - Topotecan',
  label = 'combo_1_2_3',
  ratio = c(0.001, 0.1, 0.01))
combo_1_2_3
```

## Plots

Dose effect and median effect (linearized) plots can be generated for any number of the `drug_effect` objects created above. (However, attempting to plot more than 6 objects simultaneously is not recommended, as there are not enough point shapes available.)

### Median effect plots

To generate a median effect plot ($log\left(\frac{f_a}{1 - f_a}\right)$ versus $log(D)$), from which the Dm and m parameters were calculated after fitting a linear regression, use the `median_effect_plot` function and pass in any number of `drug_effects` objects.

For example, for a plot of just paclitaxel:

```{r}
median_effect_plot(drug1)
```

And to plot paclitaxel, cisplatin, and the paclitaxel:cisplatin combination:

```{r}
median_effect_plot(drug1, drug2, combo_1_2)
```


### Dose-effect plots

Similarly, dose-effect plots ($f_a$ versus $D$, not linearized) can be generated with the `dose_effect_plot` function:

```{r}
dose_effect_plot(drug1, drug2, combo_1_2)
```

For more advanced R users, modifications can be performed on the plot. For example, the above plot extends to doses that may be too high. Two possible ways to handle this are shown below.

First, you can restrict the `fa` values to be used by the `dose_effect_plot` function (defaults to from 0.01 to 0.99), by modifying the `from`, `to`, and `by` parameters. However, this results in an unpleasant truncation of the higher effects.

```{r}
dose_effect_plot(drug1, drug2, combo_1_2, from = 0.01, to = 0.95)
```

A better way is to know that `dose_effect_plot` and `median_effect_plot` return R `ggplot` objects, which can then be modified. The following limits the X axis to between 0 and 3:

```{r}
dose_effect_plot(drug1, drug2, combo_1_2) + ggplot2::coord_cartesian(xlim = c(0, 3))
```


## Drug combination analysis

### fa-CI plot

fa-CI plots can be generated with the `fa_ci_plot` function, by passing in a drug combination object followed by the single drug objects. The order of the single drug objects **must** match the order defined by the `ratio` parameter.

The following is the fa-CI plot for the 3-drug combination:

```{r}
fa_ci_plot(combo_1_2_3, drug1, drug2, drug3)
```

Knowledge of `ggplot` objects can allow axis transformations. For example, the following displays the Y-axis on a base 10 log scale:

```{r}
fa_ci_plot(combo_1_2_3, drug1, drug2, drug3) + ggplot2::scale_y_continuous(trans='log10')
```

### fa-DRI plot

Dose reduction index (DRI) plots are generated analogously, with the `fa_dri_plot` function. Below is an fa-DRI plot with the Y-axis on a log scale.

```{r}
fa_dri_plot(combo_1_2_3, drug1, drug2, drug3) + ggplot2::scale_y_continuous(trans='log10')
```

### Calculations of CI and DRI at specified fa

The actual CI and DRI values can be displayed with the `calc_ci` and `calc_dri` functions. If no fa are specified, the calculations are performed at the fa observed in the combination.

#### 3-drug combination CI at observed fa

```{r}
calc_ci(combo_1_2_3, drug1, drug2, drug3)
```

#### 3-drug combination DRI at observed fa

```{r}
calc_dri(combo_1_2_3, drug1, drug2, drug3)
```

Or, specific fa values can be provided to generate the numbers seen in Table 4.

#### CI for 3-drug combination at fa = 50% / 75% / 90% / 95%

```{r}
calc_ci(combo_1_2_3, drug1, drug2, drug3, fa = c(0.5, 0.75, 0.9, 0.95))
```

#### DRI for 3-drug combination at fa = 50% / 75% / 90% / 95%

```{r}
calc_dri(combo_1_2_3, drug1, drug2, drug3, fa = c(0.5, 0.75, 0.9, 0.95))
```

## Non-constant ratio combination analysis

Although not done in the cited study, the `medianeffect` package also supports calculations for drug combinations that are not at a constant ratio between drug components.

A non-constant ratio drug effect object is created with the `ncr_drug_effects` function, which takes vectors of each drug in the combination, followed by a vector of observed fraction affected.

```{r}
# Create a 'fake' non-constant ratio object for testing
ncr_combo <- ncr_drug_effects(
  c(0.001, 0.002, 0.005, 0.01),
  c(0.1, 0.2, 0.5, 1),
  fa = c(0.45, 0.701, 0.910, 0.968),
  name='NCR Paclitaxel - Cisplatin',
  label = 'ncr_combo_1_2'
)
ncr_combo
```

The combination index can then be calculated, but only for the observed fractional effects, using the `ncr_calc_ci` function:

```{r}
ncr_calc_ci(ncr_combo, drug1, drug2)
```


## Appendix: Theoretical background

### Median effect equation [@chouDerivationPropertiesMichaelisMenten1976]

The median effect equation relates dose (D) to fraction affected (fa).

$$\frac{f_a}{f_u} = \left(\frac{D}{D_m}\right)^m$$

… where fraction affected plus fraction unaffected equals one, so: $f_u = 1 - f_a$

#### Dm parameter

At a dose of $D = D_m$, the fraction affected will equal 50%; hence "median effect."

#### m parameter

The $m$ parameter describes the shape of the dose-effect relationship:

* $m = 1$: hyperbolic
* $m > 1$: sigmoidal
* $m < 1$: negative (flat) sigmoidal

### Linearizing by log transformation

$$log\left(\frac{f_a}{1 - f_a}\right) = m~log(D) - m~log(D_m)$$

Fitting a linear regression of $log\left(\frac{f_a}{1 - f_a}\right)$ versus $log(D)$ allows determination of the $m$ and $D_m$ parameters.

### Solving for dose, D

$$D = D_m\left[\frac{f_a}{1 - f_a}\right]^{1/m}$$

### Solving for fraction affected, fa

$$f_a = \frac{1}{1 + \left(\frac{D_m}{D}\right)^m}$$

### Combination Index (CI) [@chouQuantitativeAnalysisDoseeffect1984]

$$CI = \sum_{i=1}^{n} \frac{(D)_i}{(D_x)_i}$$

… where for a given fraction affected $f_a$,

* $(D)_i$ is the dose of drug _i_ within the combination of _n_ drugs which together results in the fraction affected
* $(D_x)_i$ is the dose of drug _i_ alone which results in the fraction affected = $f_a$

The combination index describes the degree of synergism / antagonism, at a given fraction affected:

* CI = 1 indicates additive effect
* CI < 1 indicates synergism
* CI > 1 indicates antangonism

### Dose reduction index (DRI)

$$DRI_i = \frac{(D_x)_i}{(D)_i}$$

The reciprocal of each of the terms of the combination index (CI) reflects the fold-reduction (dose reduction index, DRI) of drug _i_ within the drug combination, at a given fractional affect $f_a$.

## References
